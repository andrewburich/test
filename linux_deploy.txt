#!/bin/bash

# Configuration
CLIENT_ID='82d1452c81a240b188d51ad01fa47a1d'
CLIENT_SECRET='toFpQx2zsqVDjiUr1Be4k3R6759fl0ICLM8YgXwc'
CS_CCID='EF35878C5A06464CB6B3B7EF692019BE-68'

if [[ $EUID -ne 0 ]]; then
	echo "This script must be run as root" 
	exit 1
fi

get_access_token() {
	curl -s -X POST -d "client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}" "https://api.crowdstrike.com/oauth2/token" | \
	 awk '/access_token/ { gsub(/[",]/,""); print $2}'
}

get_sha256() {
	curl -s -H "Authorization: Bearer ${1}" "https://api.crowdstrike.com/sensors/combined/installers/v1?offset=2&limit=1&sort=release_date%7Cdesc&filter=platform%3A%22mac%22" | \
	 awk '/sha256/ { gsub(/[",]/,""); print $2}'
}

if [ -z "$(/Applications/Falcon.app/Contents/Resources/falconctl stats | grep 'Sensor operational: true')" ]; then
	APITOKEN=$(get_access_token)
	FALCON_LATEST_SHA256=$(get_sha256 ${APITOKEN})
	curl -o /tmp/FalconSensorMacOS.pkg -s -H "Authorization: Bearer ${APITOKEN}" "https://api.crowdstrike.com/sensors/entities/download-installer/v1?id=${FALCON_LATEST_SHA256}"
	installer -verboseR -package /tmp/FalconSensorMacOS.pkg -target /
	rm /tmp/FalconSensorMacOS.pkg
	/Applications/Falcon.app/Contents/Resources/falconctl license ${CS_CCID} || true # Don't fail if the app is already licensed, but still needs a reinstall
	/Applications/Falcon.app/Contents/Resources/falconctl unload
	/Applications/Falcon.app/Contents/Resources/falconctl load
else
	echo "Crowdstrike Falcon is installed and operational"
fi
